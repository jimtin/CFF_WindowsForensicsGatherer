# State the version of CircleCI to use
version: 2.1

# Select the windows Orb, which also includes Docker
orbs:
  win: circleci/windows@2.4.0

# Set up the workflow
workflows:
  build:
    jobs:
      - build:
          context: cff_context

# Run the testing
jobs:
  build:
    # Set up executor
    executor:
      name: win/default
      shell: powershell.exe
    steps:
      # Checkout the repo
      - checkout
      
      # Set up the Windows Server
      - run:
          # Construct the Windows Server. Use environment variables for the testing username and password
          name: "Set up Windows Server"
          shell: powershell.exe
          command: |
            $password = ConvertTo-SecureString $env:COMPUTERNAME -asplaintext -force
            New-LocalUser -Name "TestAdministrator" -Password $password
            Add-LocalGroupMember -Group "Administrators" -Member "TestAdministrator"
            Enable-PSRemoting -Force 
      - run:
          # Confirm the Windows Server is running latest version of Pester
          name: "Install Pester"
          shell: powershell.exe
          command: |
            Install-Module Pester -Force -SkipPublisherCheck
            Update-Module Pester -Force
            
      # Build the cff_windowsforensicsgatherer docker
      #- run:
      #    name: "Build CFF_WindowsForensicsGatherer"
      #    shell: powershell.exe
      #    command: |
      #      docker build -t windowsforensicsgatherer .
    
      # Run the CI tests script
      - run: 
          name: "Run CI tests"
          shell: powershell.exe
          command: |
            .\Tests\runCITests.ps1
